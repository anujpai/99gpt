<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>99GPT QA Suite — AI (Gemini)</title>
<style>
  /* ---------- Simple reset & Arial only ---------- */
  html,body{height:100%;margin:0;font-family: Arial, Helvetica, sans-serif;background:#fafafa;-webkit-font-smoothing:antialiased;line-height:1.4;color:#111}
  :root{
    --accent:#ef4444; /* red */
    --accent-dark:#b91c1c;
    --muted:#6b7280;
    --card:#ffffff;
    --border:#e6e6e6;
    --shadow: 0 8px 32px rgba(0,0,0,0.06);
    --radius:14px;
  }

  /* ---------- Layout ---------- */
  .wrap{max-width:1200px;margin:28px auto;padding:20px;display:grid;grid-template-columns:280px 1fr;gap:20px;align-items:start}
  .sidebar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
  .main{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);min-height:620px}

  /* ---------- Sidebar ---------- */
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .brand img{width:48px;height:48px;border-radius:10px;object-fit:contain}
  .brand h1{font-size:18px;margin:0}
  .small{font-size:12px;color:var(--muted)}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .nav button{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px;text-align:left;cursor:pointer;font-weight:700}
  .nav button.active{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border-color:var(--accent-dark)}
  .section{margin-top:16px;border-top:1px solid var(--border);padding-top:14px}

  /* ---------- Controls ---------- */
  input[type="text"], input[type="password"], textarea{
    width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);box-sizing:border-box;font-family:Arial,monospace;
  }
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(239,68,68,0.12)}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--border);font-weight:700}
  .muted{color:var(--muted)}
  .control-group{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

  /* ---------- Cards & outputs ---------- */
  .card{background:linear-gradient(180deg,#fff,#fcfcfc);border-radius:10px;padding:12px;border:1px solid var(--border);box-shadow:0 8px 20px rgba(15,23,42,0.03)}
  .output{white-space:pre-wrap;font-family:Arial, monospace;margin-top:12px;background:#fff;padding:12px;border-radius:8px;border:1px dashed var(--border)}
  .error{background:#fff5f5;color:#7f1d1d;padding:10px;border-radius:8px;border:1px solid #fecaca}
  .label{font-size:13px;font-weight:700;margin-bottom:6px}

  /* ---------- small helpers ---------- */
  .top-actions{display:flex;gap:8px;align-items:center;margin-top:12px}
  .history-list{max-height:220px;overflow:auto;margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .history-item{background:#fff;padding:10px;border-radius:8px;border:1px solid var(--border)}
  footer{margin-top:14px;font-size:12px;color:var(--muted)}

  /* ---------- responsive ---------- */
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr; padding:12px}
    .sidebar{order:2}
    .main{order:1}
  }

  /* spinner */
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Markdown rendering (simple) */
  .md h1{font-size:20px;margin:6px 0}
  .md h2{font-size:18px;margin:6px 0}
  .md p{margin:6px 0}
  .md ul{margin:6px 0 6px 18px}
  .md ol{margin:6px 0 6px 18px}
  .md pre{background:#0b1220;color:#e6eef8;padding:10px;border-radius:6px;overflow:auto}
  .md code{background:#f3f4f6;padding:2px 4px;border-radius:4px}
</style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <div class="brand">
        <img src="cube.gif" alt="cube"/>
        <div>
          <h1>99GPT QA Suite</h1>
          <div class="small">AI-powered QA helpers</div>
        </div>
      </div>

      <nav class="nav" id="tabs">
        <button data-tab="daily" class="active">Daily Update</button>
        <button data-tab="planner">Test Planner</button>
        <button data-tab="report">Reporting Helper</button>
        <button data-tab="assign">Smart Assign</button>
        <button data-tab="json">JSON Modifier</button>
        <button data-tab="history">History</button>
      </nav>

      <div class="section">
        <div class="label">Gemini API Key</div>
        <input id="apiKey" type="password" placeholder="Paste your Gemini API key here (unsafe in production)"/>
        <div class="top-actions">
          <button id="saveKey" class="btn secondary">Save Key</button>
          <button id="clearKey" class="btn secondary">Clear Key</button>
        </div>
        <div style="margin-top:10px" class="muted">Warning: client-side keys are public. Use server proxy for production.</div>
      </div>

      <div class="section">
        <div class="label">History</div>
        <div class="history-list card" id="historyPreview"></div>
        <div class="control-group" style="margin-top:10px">
          <button id="exportHistory" class="btn secondary">Export</button>
          <button id="clearHistory" class="btn secondary">Clear</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <!-- Daily Update -->
      <div id="panel-daily" class="card panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">QA Daily Update Formatter</h2>
          <div class="muted">Powered by Gemini</div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
          <div>
            <div class="label">Report Date (MM/DD/YY)</div>
            <input id="dailyDate" type="text" />
          </div>
          <div>
            <div class="label">Build Number</div>
            <input id="dailyBuild" type="text" placeholder="e.g., 37" />
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Raw Test Notes</div>
          <textarea id="dailyNotes" placeholder="- note 1\n- note 2"></textarea>
        </div>

        <div class="top-actions">
          <button id="dailySend" class="btn">Generate Polished Update</button>
          <button id="dailyReset" class="btn secondary">Reset</button>
          <div id="dailyLoader" style="display:none"><span class="spinner"></span></div>
        </div>

        <div id="dailyOutputWrap" style="display:none;margin-top:12px"></div>
      </div>

      <!-- Planner -->
      <div id="panel-planner" class="card panel" style="display:none;margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Edge Cases & Test Planner</h2>
          <div class="muted">Ask the model to find edge cases</div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Feature topic / description</div>
          <textarea id="plannerTopic" placeholder="Describe the feature..."></textarea>
        </div>

        <div class="top-actions">
          <button id="plannerSend" class="btn">Generate Test Plan</button>
          <button id="plannerClear" class="btn secondary">Clear</button>
          <div id="plannerLoader" style="display:none"><span class="spinner"></span></div>
        </div>

        <div id="plannerOutputWrap" style="display:none;margin-top:12px"></div>
      </div>

      <!-- Reporting -->
      <div id="panel-report" class="card panel" style="display:none;margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Professional Reporting Helper</h2>
          <div class="muted">Make bug reports dev-ready</div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Raw bug report text</div>
          <textarea id="reportRaw" placeholder="Write the raw report..."></textarea>
        </div>

        <div class="top-actions">
          <button id="reportSend" class="btn">Improve Report</button>
          <button id="reportClear" class="btn secondary">Clear</button>
          <div id="reportLoader" style="display:none"><span class="spinner"></span></div>
        </div>

        <div id="reportOutputWrap" style="display:none;margin-top:12px"></div>
      </div>

      <!-- Smart Assign -->
      <div id="panel-assign" class="card panel" style="display:none;margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Smart Assignment Generator</h2>
          <div class="muted">Assign tasks to people</div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Assignees list (name: keywords)</div>
          <input id="assignList" type="text" placeholder="e.g., ajay: roundoff, anuj: daily login" />
        </div>

        <div style="margin-top:8px">
          <div class="label">Release notes / tasks</div>
          <textarea id="assignNotes" placeholder="Paste release notes..."></textarea>
        </div>

        <div class="top-actions">
          <button id="assignSend" class="btn">Categorize & Assign</button>
          <button id="assignClear" class="btn secondary">Clear</button>
          <div id="assignLoader" style="display:none"><span class="spinner"></span></div>
        </div>

        <div id="assignOutputWrap" style="display:none;margin-top:12px"></div>
      </div>

      <!-- JSON Modifier -->
      <div id="panel-json" class="card panel" style="display:none;margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">JSON Modifier</h2>
          <div class="muted">Edit top-level keys using AI</div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Paste JSON here</div>
          <textarea id="jsonRaw" placeholder='e.g. {"key":"value"}'></textarea>
        </div>

        <div style="margin-top:8px">
          <div class="label">Edit instructions for the model</div>
          <input id="jsonInstr" type="text" placeholder="E.g., change discount to 0.2, update name to 'Pro'"/>
        </div>

        <div class="top-actions">
          <button id="jsonSend" class="btn">Edit JSON with AI</button>
          <button id="jsonClear" class="btn secondary">Clear</button>
          <div id="jsonLoader" style="display:none"><span class="spinner"></span></div>
        </div>

        <div id="jsonOutputWrap" style="display:none;margin-top:12px"></div>
      </div>

      <!-- History -->
      <div id="panel-history" class="card panel" style="display:none;margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">History</h2>
          <div class="muted">Saved locally</div>
        </div>
        <div id="historyList" style="margin-top:12px"></div>
      </div>

      <footer>Note: API key is used directly from your browser. For production, proxy the requests server-side to keep your key secret.</footer>
    </main>
  </div>

<script>
/* ----------------------------- CONFIG ----------------------------- */
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
const GEMINI_ENDPOINT = (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(apiKey)}`;

/* ----------------------------- HELPERS ----------------------------- */
function $(sel){ return document.querySelector(sel) }
function $all(sel){ return Array.from(document.querySelectorAll(sel)) }

function nowShort(){ return new Date().toLocaleString(); }

function loadHistory(){ try { return JSON.parse(localStorage.getItem("99gpt_history")||"[]") } catch(e){ return [] } }
function saveHistory(arr){ try { localStorage.setItem("99gpt_history", JSON.stringify(arr)) } catch(e){} }
function addHistory(tool, input, output){
  const h = loadHistory(); h.push({ tool, input: input.slice(0,1000), output, timestamp: Date.now() }); saveHistory(h); renderHistoryPreview();
}

/* safe copy */
async function safeCopy(text){
  if(!text) return false;
  try{ if(navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); return true; } }catch(e){}
  try{ const ta=document.createElement('textarea'); ta.value=text; ta.readOnly=true; ta.style.position='absolute'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(e){}
  alert('Copy blocked — use Download');
  return false;
}

/* sanitize basic & allow <b> tags */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
function allowBoldAndUnescape(s){
  // input may already contain <b> tags from model; keep them
  return escapeHtml(s).replace(/&lt;b&gt;/g,'<b>').replace(/&lt;\/b&gt;/g,'</b>');
}

/* Simple Markdown -> HTML converter (conservative, secure-ish)
   Supports:
   - fenced code blocks with ```
   - headings #/## (h1/h2)
   - unordered lists (- or *)
   - ordered lists (1., 2.)
   - paragraphs
*/
function markdownToHtml(mdRaw){
  if (mdRaw === null || mdRaw === undefined) return '';
  // Keep <b> if present by restoring after escaping
  let text = mdRaw;
  // split code fence segments
  const parts = text.split(/```/);
  let html = '';
  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];
    if (i % 2 === 1) {
      // code block - render inside <pre><code>
      html += '<pre><code>' + escapeHtml(part) + '</code></pre>';
    } else {
      // normal text - process line by line
      const lines = part.split(/\r?\n/);
      let inUl = false, inOl = false;
      for (let ln of lines) {
        if (ln.trim() === '') {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (inOl) { html += '</ol>'; inOl = false; }
          continue;
        }
        // headings
        if (/^#{1}\s+/.test(ln)) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (inOl) { html += '</ol>'; inOl = false; }
          html += '<h1>' + allowBoldAndUnescape(ln.replace(/^#\s+/, '')) + '</h1>';
          continue;
        }
        if (/^#{2}\s+/.test(ln)) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (inOl) { html += '</ol>'; inOl = false; }
          html += '<h2>' + allowBoldAndUnescape(ln.replace(/^##\s+/, '')) + '</h2>';
          continue;
        }
        // unordered list
        if (/^(\-|\*)\s+/.test(ln)) {
          if (inOl) { html += '</ol>'; inOl = false; }
          if (!inUl) { inUl = true; html += '<ul>'; }
          html += '<li>' + allowBoldAndUnescape(ln.replace(/^(\-|\*)\s+/, '')) + '</li>';
          continue;
        }
        // ordered list
        if (/^\d+\.\s+/.test(ln)) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (!inOl) { inOl = true; html += '<ol>'; }
          html += '<li>' + allowBoldAndUnescape(ln.replace(/^\d+\.\s+/, '')) + '</li>';
          continue;
        }
        // normal paragraph
        html += '<p>' + allowBoldAndUnescape(ln) + '</p>';
      }
      if (inUl) { html += '</ul>'; inUl = false; }
      if (inOl) { html += '</ol>'; inOl = false; }
    }
  }
  return '<div class="md">' + html + '</div>';
}

/* show output wrapper with copy/download */
function showOutputWithTools(wrapperSelector, rawText) {
  const wrapper = $(wrapperSelector);
  if(!wrapper) return;
  // render markdown -> html
  const rendered = markdownToHtml(rawText);
  wrapper.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div style="font-weight:700">Generated Output</div>
      <div style="display:flex;gap:8px">
        <button class="btn secondary" data-copy>Copy</button>
        <button class="btn secondary" data-download>Download</button>
      </div>
    </div>
    <div style="margin-top:8px" class="card">${rendered}</div>
  `;
  wrapper.style.display = 'block';
  // attach copy/download listeners
  wrapper.querySelector('[data-copy]').addEventListener('click', ()=> safeCopy(rawText));
  wrapper.querySelector('[data-download]').addEventListener('click', ()=>{
    const blob = new Blob([rawText], {type:'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `99GPT_output_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(a.href);
  });
}

/* show error */
function showError(wrapperSelector, msg){
  const wrapper = $(wrapperSelector); if(!wrapper) return;
  wrapper.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`; wrapper.style.display='block';
}

/* hide wrapper */
function hideWrapper(selector){ const w = $(selector); if(w) w.style.display='none' }

/* ----------------------------- TABS ----------------------------- */
$all("#tabs button").forEach(btn=>{
  btn.addEventListener("click", ()=> {
    $all("#tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    $all(".panel").forEach(p=>p.style.display="none");
    const panel = document.getElementById("panel-"+t);
    if(panel) panel.style.display = "block";
    if(t==="history"){ renderHistoryList(); }
  });
});

/* ----------------------------- Gemini API Call ----------------------------- */
async function callGemini(apiKey, userQuery, systemPrompt, generationConfig = {}, timeoutMs = 20000, maxAttempts = 3) {
  if(!apiKey) throw new Error("Missing API key");
  const url = GEMINI_ENDPOINT(apiKey);
  const payload = {
    contents: [{ parts: [{ text: userQuery }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] },
    ...(Object.keys(generationConfig).length ? { generationConfig } : {})
  };

  let attempt = 0;
  while(attempt < maxAttempts){
    attempt++;
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeoutMs);
    try{
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(timer);
      if(!res.ok){
        const txt = await res.text().catch(()=>"");
        throw new Error(`API Error ${res.status}: ${txt}`);
      }
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || (data?.candidates?.[0]?.content?.[0]?.text) || "";
      return text;
    }catch(err){
      clearTimeout(timer);
      if(attempt >= maxAttempts) throw err;
      await new Promise(r => setTimeout(r, 500 * Math.pow(2, attempt)));
    }
  }
}

/* ----------------------------- TOOL: Daily Update ----------------------------- */
$("#dailyDate").value = (new Date()).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });

$("#dailySend").addEventListener("click", async ()=>{
  const apiKey = $("#apiKey").value.trim();
  const notes = $("#dailyNotes").value.trim();
  const build = $("#dailyBuild").value.trim();
  const date = $("#dailyDate").value.trim() || (new Date()).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });

  if(!apiKey){ alert("Paste your Gemini API key in the sidebar first."); return; }
  if(!notes || !build){ showError("#dailyOutputWrap","Please enter Build Number and Test Notes."); return; }

  const systemPrompt = `You are a professional QA Reporting Assistant. Take raw testing notes and format them into a clean daily update.
Strictly follow this output format:
1. Line 1: 'Test covered (${date})'
2. Line 2: '<b>Mojo Build ${build}</b>'
3. Line 3: 'Tested'
4. Lines 4+: A clean, numbered list of the notes.
- Fix only grammar and spelling.
- Use simple, easy-to-understand words.
- Do not add any introductory or concluding sentences.`;

  const userQuery = `Raw Notes to process:\n${notes}`;

  try{
    $("#dailyLoader").style.display = "inline-block";
    hideWrapper("#dailyOutputWrap");
    const text = await callGemini(apiKey, userQuery, systemPrompt, {});
    showOutputWithTools("#dailyOutputWrap", text);
    addHistory("Daily Update", notes, text);
  }catch(err){
    showError("#dailyOutputWrap", err.message || String(err));
  }finally{ $("#dailyLoader").style.display = "none"; }
});

/* ----------------------------- TOOL: Planner ----------------------------- */
$("#plannerSend").addEventListener("click", async ()=>{
  const apiKey = $("#apiKey").value.trim();
  const topic = $("#plannerTopic").value.trim();
  if(!apiKey){ alert("Paste your Gemini API key in the sidebar first."); return; }
  if(!topic){ showError("#plannerOutputWrap","Please enter a feature topic or description."); return; }

  const systemPrompt = `You are a creative QA Test Designer. Analyze a feature and suggest Test Cases and critical Edge Cases/Risk Areas.
Format your response clearly using simple headings and numbered lists. Do not use Markdown.
- Focus on platform issues, concurrent actions, network failures, and boundary conditions.
- Do NOT add any extra introductory text. Just provide the lists.`;
  const userQuery = `Feature Topic/Description: ${topic}`;

  try{
    $("#plannerLoader").style.display = "inline-block";
    hideWrapper("#plannerOutputWrap");
    const text = await callGemini(apiKey, userQuery, systemPrompt, {});
    showOutputWithTools("#plannerOutputWrap", text);
    addHistory("Test Planner", topic, text);
  }catch(err){
    showError("#plannerOutputWrap", err.message || String(err));
  }finally{ $("#plannerLoader").style.display = "none"; }
});

/* ----------------------------- TOOL: Reporting ----------------------------- */
$("#reportSend").addEventListener("click", async ()=>{
  const apiKey = $("#apiKey").value.trim();
  const raw = $("#reportRaw").value.trim();
  if(!apiKey){ alert("Paste your Gemini API key in the sidebar first."); return; }
  if(!raw){ showError("#reportOutputWrap","Please enter the raw text of your bug report."); return; }

  const systemPrompt = `You are a QA Report Refiner. Take raw bug report text and transform it into a clear, professional report for a developer.
Strictly follow this formatting:
1. Identify the main issue area and make it bold.
2. Clean up grammar and spelling.
3. Ensure all issues are in a clean, numbered list (1., 2., 3., etc.).
4. Do NOT add any extra introductory text or jargon. Just provide the list.`;
  const userQuery = `Raw Bug Report Text:\n${raw}`;

  try{
    $("#reportLoader").style.display = "inline-block";
    hideWrapper("#reportOutputWrap");
    const text = await callGemini(apiKey, userQuery, systemPrompt, {});
    showOutputWithTools("#reportOutputWrap", text);
    addHistory("Reporting Helper", raw, text);
  }catch(err){
    showError("#reportOutputWrap", err.message || String(err));
  }finally{ $("#reportLoader").style.display = "none"; }
});

/* ----------------------------- TOOL: Smart Assign ----------------------------- */
$("#assignSend").addEventListener("click", async ()=>{
  const apiKey = $("#apiKey").value.trim();
  const list = $("#assignList").value.trim();
  const notes = $("#assignNotes").value.trim();
  if(!apiKey){ alert("Paste your Gemini API key in the sidebar first."); return; }
  if(!list || !notes){ showError("#assignOutputWrap","Please enter Release Notes and the list of Assignees."); return; }

  const systemPrompt = `You are a simple delegation tool. Analyze release notes, categorize tasks, and assign them based on the assignees mapping provided.
Assignees list format: "Name: keyword1, keyword2".
Rules:
- Preserve any lines starting with "POC" or "Feature" as-is.
- For task lines (other lines), match keywords case-insensitively as substrings.
- When a task matches a keyword, append " : [Assignee]" to the line.
- If a task matches multiple assignees, prefer the first matching assignee in the provided assignee list.
- Do NOT invent POCs or assignees.
Format the final output as the original notes with assignments appended where applicable.`;

  const userQuery = `Assignees:\n${list}\n\nRelease Notes:\n${notes}`;

  try{
    $("#assignLoader").style.display = "inline-block";
    hideWrapper("#assignOutputWrap");
    const text = await callGemini(apiKey, userQuery, systemPrompt, {});
    showOutputWithTools("#assignOutputWrap", text);
    addHistory("Smart Assign", `${list}\n---\n${notes}`, text);
  }catch(err){
    showError("#assignOutputWrap", err.message || String(err));
  }finally{ $("#assignLoader").style.display = "none"; }
});

/* ----------------------------- TOOL: JSON Modifier (AI) ----------------------------- */
$("#jsonSend").addEventListener("click", async ()=>{
  const apiKey = $("#apiKey").value.trim();
  const raw = $("#jsonRaw").value.trim();
  const instr = $("#jsonInstr").value.trim();
  if(!apiKey){ alert("Paste your Gemini API key in the sidebar first."); return; }
  if(!raw){ showError("#jsonOutputWrap","Please paste some JSON first."); return; }
  try{ JSON.parse(raw); } catch(e){ showError("#jsonOutputWrap","Invalid JSON — please correct before sending to AI."); return; }

  const systemPrompt = `You are a JSON editor assistant. Given a JSON object and an instruction, produce the edited JSON object only (no explanation). Preserve top-level keys unless instruction says to add/remove keys. Keep values typed (true/false/null/numbers/strings) where appropriate.`;
  const userQuery = `JSON:\n${raw}\n\nEdit instructions:\n${instr}\n\nReturn only the updated JSON.`;

  try{
    $("#jsonLoader").style.display = "inline-block";
    hideWrapper("#jsonOutputWrap");
    const text = await callGemini(apiKey, userQuery, systemPrompt, {});
    const cleaned = text.replace(/^\s*```(?:json)?\s*/,'').replace(/\s*```\s*$/,'').trim();
    // validate JSON
    const parsed = JSON.parse(cleaned);
    const out = JSON.stringify(parsed, null, 2);
    // show as code block and provide copy/download
    showOutputWithTools("#jsonOutputWrap", out);
    addHistory("JSON Modifier", raw, out);
  }catch(err){
    showError("#jsonOutputWrap", err.message || String(err));
  }finally{ $("#jsonLoader").style.display = "none"; }
});

/* ----------------------------- SAVE/CLEAR KEY & HISTORY ----------------------------- */
$("#saveKey").addEventListener("click", ()=>{ localStorage.setItem("99gpt_apikey", $("#apiKey").value.trim()); alert("Saved (client-side)"); });
$("#clearKey").addEventListener("click", ()=>{ localStorage.removeItem("99gpt_apikey"); $("#apiKey").value=''; alert("Cleared"); });

$("#exportHistory").addEventListener("click", ()=>{ const data = JSON.stringify(loadHistory(), null, 2); const blob = new Blob([data], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`99gpt_history_${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href); });
$("#clearHistory").addEventListener("click", ()=>{ localStorage.removeItem("99gpt_history"); renderHistoryPreview(); renderHistoryList(); });

/* ----------------------------- HISTORY RENDERING ----------------------------- */
function renderHistoryPreview(){
  const preview = $("#historyPreview");
  if(!preview) return;
  const list = loadHistory().slice().reverse().slice(0,6);
  preview.innerHTML = list.length ? list.map(item => `<div style="padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff"><div style="font-weight:700">${escapeHtml(item.tool)}</div><div style="font-size:12px;color:${'#6b7280'}">${new Date(item.timestamp).toLocaleString()}</div></div>`).join("") : '<div class="muted">No recent items</div>';
}

function renderHistoryList(){
  const container = $("#historyList");
  const items = loadHistory().slice().reverse();
  if(!container) return;
  if(!items.length){ container.innerHTML = '<div class="muted">No history yet.</div>'; return; }
  container.innerHTML = '';
  items.forEach((it, idx) => {
    const div = document.createElement('div'); div.className='history-item';
    // render markdown/HTML for output
    const outHtml = markdownToHtml(it.output);
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${escapeHtml(it.tool)}</strong><span class="muted">${new Date(it.timestamp).toLocaleString()}</span></div>
      <div style="margin-top:8px;font-size:13px"><strong>Input:</strong> <div style="font-style:italic;margin-top:6px;white-space:pre-wrap">${escapeHtml(it.input)}</div></div>
      <div style="margin-top:8px">${outHtml}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button data-copy class="btn secondary">Copy Output</button>
        <button data-download class="btn secondary">Download</button>
      </div>`;
    // copy & download handlers
    div.querySelector('[data-copy]').addEventListener('click', ()=> safeCopy(it.output));
    div.querySelector('[data-download]').addEventListener('click', ()=>{
      const blob = new Blob([it.output], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`99GPT_history_${idx}_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(a.href);
    });
    container.appendChild(div);
  });
}

/* ----------------------------- Init ----------------------------- */
(function init(){
  const savedKey = localStorage.getItem("99gpt_apikey");
  if(savedKey) $("#apiKey").value = savedKey;
  $("#dailyDate").value = (new Date()).toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'2-digit'});
  renderHistoryPreview();
  // hide other panels
  $all(".panel").forEach(p => { if(p.id !== "panel-daily") p.style.display = "none"; });
})();
</script>
</body>
</html>
